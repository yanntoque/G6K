{#
The MIT License (MIT)

Copyright (c) 2015 Jacques Archimède

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is furnished
to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
#}

{% extends "EUREKAG6KBundle:admin/layout:pagelayout.html.twig" %}

{% import _self as page %}

{% block content %}
<h2>{{ 'Simulators definition'|trans }}</h2>
{% if simulator is not empty %}
<button class="btn btn-warning update-button save-simulator">{{ 'Save'|trans }} <span class="glyphicon glyphicon-save"></span></button>
{% endif %}
<div class="navbar-default navbar-side" role="navigation">
	<div class="sidebar-collapse">
		<div id="simulators" class="nav panel panel-primary">
			<div class="panel-heading"><h3>{{ 'Simulators'|trans }}</h3></div>
			<div class="panel-body">
				<div>
					<form action="{{ path('eureka_g6k_admin_simulator_crud', {'simulator': 'new', 'crud': 'create'}) }}">
					<button id="btnAddNewSimulator" class="btn btn-default pull-right">{{ 'Create simulator'|trans }} <span class="glyphicon glyphicon-plus-sign"></span></button>
					</form>
				</div>
				<div>
					<form action="{{ path('eureka_g6k_admin_simulator_crud', {'simulator': 'new', 'crud': 'import'}) }}">
					<button id="btnImportSimulator" class="btn btn-default pull-right">{{ 'Import simulator'|trans }} <span class="glyphicon glyphicon-import"></span></button>
					</form>
				</div>
				<ul class="nav nav-pills nav-stacked">
					{% for simu in simulators %}
					<li><a href="{{ path('eureka_g6k_admin_simulators') }}/{{ simu.file }}">{{ simu.label }}</a></li>
					{% endfor %}
				</ul>
			</div>
		</div>
	</div>
	<div id="trigger"></div>
</div>

<div id="page-wrapper" class="content">
	<div id="page-simulators">
		<div class="row">
			<div class="col-md-12">
				{% if simulator is not empty %}
				<div class="panel-group" id="simulator" role="tablist" aria-multiselectable="true">
					<div class="panel panel-primary">
						<div id="simulator-options-panel" class="panel-heading" role="tab">
							<a class="btn btn-primary pull-right help-view-button" href="{{ path('eureka_g6k_admin_documentation', { 'document' : 'simulators-management' }) }}" target="_blank" title=""><span>{{ 'Need help ?'|trans }}</span>&nbsp;&nbsp;<span class="glyphicon glyphicon-book"></span></a> 
							{% if hiddens.action != 'create' and valid %}
							<a href="{{ path('eureka_g6k_admin_simulator_calcul', {'simu': simulator.name, 'view': simulator.defaultView }) }}" class="btn btn-primary pull-right view-button" title="{{ 'Try it'|trans }}" target="_blank"><span class="button-label">{{ 'Try it'|trans }}</span> <span class="glyphicon glyphicon-eye-open"></span></a>
							{% endif %}
							<button class="btn btn-primary pull-right update-button edit-simulator" title="{{ 'Edit'|trans }}"><span class="button-label">{{ 'Edit'|trans }}</span> <span class="glyphicon glyphicon-pencil"></span></button>
							{% if hiddens.action != 'create' %}
							<a class="btn btn-primary pull-right link-button export-simulator" href="{{ path('eureka_g6k_admin_simulator_crud', {'simulator': simulator.name, 'crud': 'export'}) }}" title="{{ 'Export simulator'|trans }}"><span class="button-label">{{ 'Export simulator'|trans }}</span> <span class="glyphicon glyphicon-export"></span></a>
							{% if hiddens.updated %}
							<a class="btn btn-primary pull-right link-button publish-simulator" href="{{ path('eureka_g6k_admin_simulator_crud', {'simulator': simulator.name, 'crud': 'publish'}) }}" title="{{ 'Publish simulator'|trans }}"><span class="button-label">{{ 'Publish simulator'|trans }}</span> <span class="glyphicon glyphicon-share"></span></a>
							{% endif %}
							{% endif %}
							<form id="save-form" action="{{ path('eureka_g6k_admin_simulator_crud', {'simulator': simulator.name, 'crud': 'save'}) }}" method="post">
							<input type="hidden" name="simulator" value="" />
							<input type="hidden" name="sources" value="" />
							<input type="hidden" name="datas" value="" />
							<input type="hidden" name="steps" value="" />
							<input type="hidden" name="rules" value="" />
							<input type="hidden" name="profiles" value="" />
							<input type="hidden" name="update" value="true" />
							{% if hiddens.action == 'create' -%}<input type="hidden" name="create" value="true" />{%- endif %}
							<h4 class="panel-title">{{ simulator.label }}</h4>
							</form>
						</div>
						<div class="panel-body">
							<div class="panel panel-default" id="simulator-attributes-panel-holder">
								<div class="panel-body">
									<div class="attributes-container">
										<div>
										{{ page.showAttribute('simulator', 'text', 'name', 'Name'|trans, simulator.name, simulator.name, true, 'name') }}
										{{ page.showAttribute('simulator', 'text', 'label', 'Label'|trans, simulator.label, simulator.label, true, 'label') }}
										{{ page.showAttribute('simulator', 'text', 'defaultView', 'Default view'|trans, simulator.defaultView, simulator.defaultView, true, 'defaultView') }}
										{{ page.showAttribute('simulator', 'text', 'referer', 'Main referer'|trans, simulator.referer, simulator.referer, true, 'referer') }}
										{{ page.showAttribute('simulator', 'select', 'dateFormat', 'Date format'|trans, simulator.dateFormat, simulator.dateFormat|trans, true, 'Select a format'|trans, { 'd/m/Y':'d/m/Y'|trans, 'm/d/Y':'m/d/Y'|trans, 'd-m-Y':'d-m-Y'|trans, 'm-d-Y':'m-d-Y'|trans, 'Y-m-d':'Y-m-d'|trans }) }}
										{{ page.showAttribute('simulator', 'text', 'decimalPoint', 'Decimal point'|trans, simulator.decimalPoint, simulator.decimalPoint, true, 'Decimal point'|trans) }}
										{{ page.showAttribute('simulator', 'select', 'moneySymbol', 'Currency symbol'|trans, simulator.moneySymbol, simulator.moneySymbol, true, 'Select a symbol'|trans, {'฿':'฿', 'B/.':'B/.', '₵':'₵', '¢':'¢', '₡':'₡', 'Kč':'Kč', '$':'$', '₫':'₫', '€':'€', 'ƒ':'ƒ', 'Ft':'Ft', '₲':'₲', '₴':'₴', '₭':'₭', 'L':'L', '£ / ₤':'£ / ₤', '₺':'₺', '₥':'₥', '₦':'₦', 'S/.':'S/.', '₱':'₱', 'P':'P', 'R':'R', 'RM':'RM', '₹ / ₨':'₹ / ₨', '৲':'৲', '৳':'৳', 'R$':'R$', '₪':'₪', '₮':'₮', '₩':'₩', '¥':'¥', 'Ұ':'Ұ', 'zł':'zł' }) }}
										{{ page.showAttribute('simulator', 'select', 'symbolPosition', 'Symbol position'|trans, simulator.symbolPosition, simulator.symbolPosition, true, 'Select a position'|trans, {'before':'before currency'|trans, 'after':'after currency'|trans}) }}
										{{ page.showAttribute('simulator', 'checkbox', 'dynamic', 'Interactive UI'|trans, simulator.dynamic, simulator.dynamic, true, 'dynamic') }}
										{{ page.showAttribute('simulator', 'checkbox', 'memo', 'Data memo ?'|trans, simulator.memo, simulator.memo, true, 'memo') }}
										</div>
									</div>
								</div>
							</div>
							<div class="panel panel-default" id="simulator-description-panel-holder">
								<div class="panel-heading">
									{{ 'Description'|trans }}
								</div>
								<div class="panel-body simulator-description rich-text">
									{{ page.paragraphs(simulator.replaceByDataLabel(simulator.description)|jscode) }}
								</div>
							</div>
							<div class="panel panel-default" id="simulator-related-informations-panel-holder">
								<div class="panel-heading">
									{{ 'Related informations'|trans }}
								</div>
								<div class="panel-body simulator-related-informations rich-text">
									{{ page.paragraphs(simulator.replaceByDataLabel(simulator.relatedInformations)|jscode) }}
								</div>
							</div>
							<div class="panel panel-default" id="simulator-elements-panel">
							{{ page.showSources ( simulator ) }}
							{{ page.showDatas ( simulator ) }}
							{{ page.showSteps ( simulator ) }}
							{{ page.showBusinessRules ( simulator, _context ) }}
							{{ page.showProfiles ( simulator ) }}
							</div>
						</div>
					</div>
				</div>
				{% elseif hiddens.action == 'import' %}
				<div id="simulator" class="panel panel-primary">
					<div class="panel-heading">
					<a class="btn btn-primary pull-right help-view-button" href="{{ path('eureka_g6k_admin_documentation', { 'document' : 'simulators-management' }) }}" target="_blank" title=""><span>{{ 'Need help ?'|trans }}</span>&nbsp;&nbsp;<span class="glyphicon glyphicon-book"></span></a> 
					<h4 class="panel-title">{{ 'Simulator : import'|trans }}</h4>
					</div>
					<div class="panel-body">
						<div class="alert alert-danger" role="alert">
							<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
							<span class="sr-only">{{ 'Error'|trans }} :</span>
							<span class="error-message"></span>
							<ul></ul>
						</div>
						<form id="simulator-import-form" method="post" action="{{ path('eureka_g6k_admin_simulator_crud', {'simulator': 'new', 'crud': 'doimport'}) }}" enctype="multipart/form-data">
						<div class="panel panel-default" id="simulator-import-panel-holder">
							<div class="panel-heading">
								{{ 'Import simulator'|trans }}
							</div>
							<div class="panel-body simulator-file">
								<div class="form-group col-sm-12">    
									<label class="col-sm-2 control-label" for="simulator-file">{{ 'Simulator file'|trans }}</label>    
									<div class="col-sm-10">        
										<input type="file" name="simulator-file" accept=".xml" class="form-control input-sm" />
									</div>
								</div>
								<div class="form-group col-sm-12">    
									<label class="col-sm-2 control-label" for="simulator-stylesheet">{{ 'Stylesheet (optional)'|trans }}</label>    
									<div class="col-sm-10">        
										<input type="file" name="simulator-stylesheet" accept="text/css" class="form-control input-sm" />
									</div>
								</div>
							</div>
						</div>
						<button id="btnDoImportSimulator" class="btn btn-primary pull-right">{{ 'Import'|trans }}</button>
						</form>
					</div>
				</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
{{ parent() }}<script type="text/javascript" src="{{ asset('bundles/eurekag6k/admin/js/g6k.admin.simulators.js') }}"></script>
<script type="text/javascript" src="{{ asset('bundles/eurekag6k/admin/js/g6k.admin.simulators.sources.js') }}"></script>
<script type="text/javascript" src="{{ asset('bundles/eurekag6k/admin/js/g6k.admin.simulators.datas.js') }}"></script>
<script type="text/javascript" src="{{ asset('bundles/eurekag6k/admin/js/g6k.admin.simulators.steps.js') }}"></script>
<script type="text/javascript" src="{{ asset('bundles/eurekag6k/admin/js/g6k.admin.simulators.rules.js') }}"></script>
<script type="text/javascript" src="{{ asset('bundles/eurekag6k/admin/js/g6k.admin.simulators.profiles.js') }}"></script>
<script type="text/javascript" src="{{ asset('bundles/eurekag6k/admin/js/css-validator/csslint.min.js') }}"></script>
<script type="text/javascript" src="{{ asset('bundles/eurekag6k/admin/js/jquery.jeditable/jquery.jeditable.js') }}"></script>
{% endblock %}
 
{% macro showDatas(simulator) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('datas' , 'Datas'|trans, 'primary', '', 'sortable', [{ 'label': 'Add'|trans, 'icon': 'glyphicon-plus-sign', 'dropdown': [{ 'class': 'add-data', 'label': 'Add data'|trans }, { 'class': 'add-datagroup', 'label': 'Add datagroup'|trans} ] }] ) }}
{% for data in simulator.datas %}
	{% if data.class == "DataGroup" %}
	{{ page.openCollapsiblePanel('datagroup-' ~ data.id , 'Group'|trans ~ ' ' ~ data.label, 'success', loop.index == 1 ? 'in' : '', 'sortable', [{ 'class': 'delete-datagroup', 'label': 'Delete'|trans , 'icon': 'glyphicon-minus-sign' }, { 'class': 'add-data', 'label': 'Add data'|trans, 'icon': 'glyphicon-plus-sign' }, { 'class': 'edit-datagroup', 'label': 'Edit datagroup'|trans, 'icon': 'glyphicon-pencil' }] ) }}
	<div class="panel panel-default data-container datagroup" id="datagroup-{{ data.id }}-attributes-panel" data-id="{{ data.id }}">
		<div class="panel-body">
			<div class="attributes-container">
				<div>
				{{ page.showAttribute('datagroup-'~data.id, 'text', 'name', 'Group Name'|trans, data.name, data.name, true, 'Group name'|trans) }}
				{{ page.showAttribute('datagroup-'~data.id, 'text', 'label', 'Group Label'|trans, data.label, data.label, true, 'Group label'|trans) }}
				</div>
			</div>
		</div>
	</div>
	<div class="panel panel-default description-panel" id="datagroup-{{ data.id }}-description-panel">
		<div class="panel-heading">
			{{ 'Description'|trans }}
		</div>
		<div class="panel-body  datagroup-description rich-text">
			{{ page.paragraphs(simulator.replaceByDataLabel(data.description)|jscode) }}
		</div>
	</div>
	<div class="panel panel-default datas-panel" id="datagroup-{{ data.id }}-datas-panel">
		<div class="panel-body sortable">
		{% for gdata in data.datas %}
			{{ page.showData(gdata, data.id, 'datagroup-data', loop.index == 1 ? 'in' : '') }}
		{% endfor %}
		</div>
	</div>
	{{ page.closeCollapsiblePanel() }}  
	{% else %}
	{{ page.showData(data, '', 'data', loop.index == 1 ? 'in' : '') }}
	{% endif %}
{% endfor %}
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}

{% macro showBusinessRules(simulator, context) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('businessrules' , 'Business rules'|trans, 'primary', '', 'sortable', [{ 'class': 'add-rule', 'label': 'Add'|trans, 'icon': 'glyphicon-plus-sign' }] ) }}
<div id="business-rules">
{% for rule in simulator.businessRules %}
	<div id="{{ rule.elementId }}" class="panel panel-info sortable rule-container">
		<div class="panel-heading" role="tab">
			<button class="btn btn-info pull-right update-button delete-rule" data-parent="#{{ rule.elementId }}" title="{{ 'Delete'|trans }}"><span class="button-label">{{ 'Delete'|trans }}</span> <span class="glyphicon glyphicon-minus-sign"></span></button>
			<button class="btn btn-info pull-right update-button edit-rule" data-parent="#{{ rule.elementId }}" title="{{ 'Edit'|trans }}"><span class="button-label">{{ 'Edit'|trans }}</span> <span class="glyphicon glyphicon-pencil"></span></button>
			<h4 class="panel-title">
				<a data-toggle="collapse" data-parent="#business-rules" href="#collapse{{ rule.elementId }}" aria-expanded="true" aria-controls="collapse{{ rule.elementId }}">{{ 'Rule'|trans }} #<span class="rule-id">{{ rule.id }}</span> <span class="rule-name">{{ rule.name }}</span> : <span class="rule-label">{{ rule.label }}</span></a>
			</h4>
		</div>
		<div id="collapse{{ rule.elementId }}" class="panel-body panel-collapse collapse" role="tabpanel">
			<div class="panel panel-default conditions-panel">
				<div class="panel-heading"><h4>{{ 'When ...'|trans }}</h4></div>
				<div class="panel-body">
					<ul class="rule-conditions" data-value="{{ rule.conditions }}" data-rule-element-id="{{ rule.elementId }}" data-rule-id="{{ rule.id }}">
					{{ page.showCondition(rule.extendedConditions) }}
					</ul>
				</div>
			</div>
			{% if rule.ifActions is not empty %}
			<div class="panel panel-default if-actions-panel">
				<div class="panel-heading"><h4>{{ 'then do ...'|trans }}</h4></div>
				<div class="panel-body">
					{% for action in rule.ifActions %}
					{{ page.showRuleAction(action, simulator, context.actions) }}
					{% endfor %}
				</div>
			</div>
			{% endif %}
			{% if rule.elseActions is not empty %}
			<div class="panel panel-default else-actions-panel">
				<div class="panel-heading"><h4>{{ 'else do ...'|trans }}</h4></div>
				<div class="panel-body">
					{% for action in rule.elseActions %}
					{{ page.showRuleAction(action, simulator, context.actions) }}
					{% endfor %}
				</div>
			</div>
			{% endif %}
		</div>
	</div>
{% endfor %}
</div>
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}

{% macro showRuleAction(action, simulator, actions) %}
<div class="rule-action" data-id="{{ action.id }}" data-name="{{ action.name }}" data-target="{{ action.target }}" data-data="{{ action.data }}" data-datagroup="{{ action.datagroup }}" data-step="{{ action.step }}" data-panel="{{ action.panel }}" data-fieldset="{{ action.fieldset }}" data-column="{{ action.column }}" data-fieldrow="{{ action.fieldrow }}" data-field="{{ action.field }}" data-blockinfo="{{ action.blockinfo }}" data-chapter="{{ action.chapter }}" data-section="{{ action.section }}" data-prenote="{{ action.prenote }}" data-postnote="{{ action.postnote }}" data-action="{{ action.action }}" data-footnote="{{ action.footnote }}" data-choice="{{ action.choice }}" data-value="{{ action.value }}">
{% set targetlib = 'the ' ~ action.target %}
{% if action.name == 'notifyError' or action.name == 'notifyWarning' %}
	<span class="action-name">{{ action.name == 'notifyError' ? 'notify Error'|trans : 'notify Warning'|trans }} : </span> <span class="action-value">«{{ action.value }}»</span> <span class="action-target"> {{ 'on'|trans }} {{ targetlib|trans }} </span>
	{% if action.target == 'data' %}
		<span class="action-data"><var class="data" data-id="{{ action.data }}">«{{ simulator.getDataById(action.data).label }}»</var></span>
	{% elseif action.target == 'datagroup' %}
		<span class="action-datagroup"><var class="datagroup" data-id="{{ action.datagroup }}">«{{ simulator.getDataGroupByName(action.datagroup).label }}»</var></span>
	{% endif %}
{% elseif action.name == 'hideObject' or action.name == 'showObject' %}
	{% set actionNode = simulator.controller.helper.findAction(action.name, actions) %}
	{% set step = simulator.getStepById(action.step) %}
	{% set optionNode = simulator.controller.helper.findActionOption('objectId', action.target, actionNode) %}
	<span class="action-name">{{ action.name == 'hideObject' ? 'hide'|trans : 'show'|trans }}</span> <span class="action-target">{{ targetlib|trans }}</span>
	{% if action.target == 'step' %}
		<span class="action-step">«{{ simulator.controller.helper.findActionField([{'stepId': action.step}], optionNode).label }}»</span>
	{% elseif action.target == 'panel' %}
		<span class="action-panel">«{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}], optionNode).label }}»</span>
		<span class="action-step"> {{ 'of step «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}], optionNode).label}) }}</span>
	{% elseif action.target == 'fieldset' %}
		<span class="action-fieldset">«{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}], optionNode).label }}»</span>
		<span class="action-panel"> {{ 'in panel «%panel%»'|trans({'%panel%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}], optionNode).label}) }}</span>
		<span class="action-step"> {{ 'of step «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}], optionNode).label}) }}</span>
	{% elseif action.target == 'column' %}
		<span class="action-column">«{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}, {'columnId': action.column}], optionNode).label }}»</span>
		<span class="action-fieldset"> {{ 'in fieldset «%fieldset%»'|trans({'%fieldset%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}], optionNode).label}) }}</span>
		<span class="action-panel"> {{ 'of panel «%panel%»'|trans({'%panel%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}], optionNode).label}) }}</span>
		<span class="action-step"> {{ 'of step «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}], optionNode).label}) }}</span>
	{% elseif action.target == 'fieldrow' %}
		<span class="action-fieldrow">«{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}, {'fieldrowId': action.fieldrow}], optionNode).label }}»</span>
		<span class="action-fieldset"> {{ 'in fieldset «%fieldset%»'|trans({'%fieldset%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}], optionNode).label}) }}</span>
		<span class="action-panel"> {{ 'of panel «%panel%»'|trans({'%panel%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}], optionNode).label}) }}</span>
		<span class="action-step"> {{ 'of step «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}], optionNode).label}) }}</span>
	{% elseif action.target == 'field' %}
		{% set fieldset = step.panelById(action.panel).fieldSetById(action.fieldset) %}
		{% if fieldset.disposition == 'grid' %}
		<span class="action-field">«{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}, {'fieldrowId': action.fieldrow}, {'fieldId': action.field}], optionNode).label }}»</span>
		<span class="action-fieldrow"> {{ 'in'|trans }} «{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}, {'fieldrowId': action.fieldrow}], optionNode).label }}»</span>
		<span class="action-fieldset"> {{ 'of fieldset «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}], optionNode).label}) }}</span>
		{% else %}
		<span class="action-field">«{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}, {'fieldId': action.field}], optionNode).label }}»</span>
		<span class="action-fieldset"> {{ 'in fieldset «%fieldset%»'|trans({'%fieldset%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}], optionNode).label}) }}</span>
		{% endif %}
		<span class="action-panel"> {{ 'of panel «%panel%»'|trans({'%panel%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}], optionNode).label}) }}</span>
		<span class="action-step"> {{ 'of step «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}], optionNode).label}) }}</span>
	{% elseif action.target == 'blockinfo' %}
		<span class="action-blockinfo">«{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'blockinfoId': action.blockinfo}], optionNode).label }}»</span>
		<span class="action-panel"> {{ 'in panel «%panel%»'|trans({'%panel%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}], optionNode).label}) }}</span>
		<span class="action-step"> {{ 'of step «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}], optionNode).label}) }}</span>
	{% elseif action.target == 'chapter' %}
		<span class="action-chapter">«{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'blockinfoId': action.blockinfo}, {'chapterId': action.chapter}], optionNode).label }}»</span>
		<span class="action-blockinfo"> {{ 'in blockinfo «%blockinfo%»'|trans({'%blockinfo%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'blockinfoId': action.blockinfo}], optionNode).label }) }}</span>
		<span class="action-panel"> {{ 'of panel «%panel%»'|trans({'%panel%':simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}], optionNode).label}) }}</span>
		<span class="action-step"> {{ 'of step «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}], optionNode).label}) }}</span>
	{% elseif action.target == 'section' %}
		<span class="action-section">«{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'blockinfoId': action.blockinfo}, {'chapterId': action.chapter}, {'sectionId': action.section}], optionNode).label }}»</span>
		<span class="action-chapter"> {{ 'in'|trans }} «{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'blockinfoId': action.blockinfo}, {'chapterId': action.chapter}], optionNode).label }}»</span>
		<span class="action-blockinfo"> {{ 'of blockinfo «%blockinfo%»'|trans({'%blockinfo%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'blockinfoId': action.blockinfo}], optionNode).label }) }}</span>
		<span class="action-panel"> {{ 'of panel «%panel%»'|trans({'%panel%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}], optionNode).label}) }}</span>
		<span class="action-step"> {{ 'of step «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}], optionNode).label}) }}</span>
	{% elseif action.target == 'prenote' %}
		{% set fieldset = step.panelById(action.panel).fieldSetById(action.fieldset) %}
		{% if fieldset.disposition == 'grid' %}
		<span class="action-prenote"> {{ 'of field «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}, {'fieldrowId': action.fieldrow}, {'fieldId': action.prenote}], optionNode).label}) }}</span>
		<span class="action-fieldrow"> {{ 'in'|trans }} «{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}, {'fieldrowId': action.fieldrow}], optionNode).label }}»</span>
		<span class="action-fieldset"> {{ 'of fieldset «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}], optionNode).label}) }}</span>
		{% else %}
		<span class="action-prenote"> {{ 'of field «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}, {'fieldId': action.prenote}], optionNode).label }) }}</span>
		<span class="action-fieldset"> {{ 'in fieldset «%fieldset%»'|trans({'%fieldset%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}], optionNode).label}) }}</span>
		{% endif %}
		<span class="action-panel"> {{ 'of panel «%panel%»'|trans({'%panel%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}], optionNode).label}) }}</span>
		<span class="action-step"> {{ 'of step «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}], optionNode).label}) }}</span>
	{% elseif action.target == 'postnote' %}
		{% set fieldset = step.panelById(action.panel).fieldSetById(action.fieldset) %}
		{% if fieldset.disposition == 'grid' %}
		<span class="action-postnote"> {{ 'of field «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}, {'fieldrowId': action.fieldrow}, {'fieldId': action.postnote}], optionNode).label }) }}</span>
		<span class="action-fieldrow"> {{ 'in'|trans }} «{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}, {'fieldrowId': action.fieldrow}], optionNode).label }}»</span>
		<span class="action-fieldset"> {{ 'of fieldset «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}], optionNode).label}) }}</span>
		{% else %}
		<span class="action-postnote"> {{ 'of field «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}, {'fieldId': action.postnote}], optionNode).label }) }}</span>
		<span class="action-fieldset"> {{ 'in fieldset «%fieldset%»'|trans({'%fieldset%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}, {'fieldsetId': action.fieldset}], optionNode).label}) }}</span>
		{% endif %}
		<span class="action-panel"> {{ 'of panel «%panel%»'|trans({'%panel%': simulator.controller.helper.findActionField([{'stepId': action.step}, {'panelId': action.panel}], optionNode).label}) }}</span>
		<span class="action-step"> {{ 'of step «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}], optionNode).label }) }}</span>
	{% elseif action.target == 'footnote' %}
		<span class="action-footnote">«{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'footnoteId': action.footnote}], optionNode).label }}»</span>
		<span class="action-step"> {{ 'of step «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}], optionNode).label }) }}</span>
	{% elseif action.target == 'action' %}
		<span class="action-action">«{{ simulator.controller.helper.findActionField([{'stepId': action.step}, {'actionId': action.action}], optionNode).label }}»</span>
		<span class="action-step"> {{ 'of step «%label%»'|trans({'%label%': simulator.controller.helper.findActionField([{'stepId': action.step}], optionNode).label }) }}</span>
	{% elseif action.target == 'choice' %}
		<span class="action-choice">«{{ simulator.controller.helper.findActionField([action.data, action.choice], optionNode).label }}»</span>
		<span class="action-data"> {{ 'of data «%label%»'|trans({'%label%': simulator.replaceByDataLabel(action.data).label }) }}</span>
	{% endif %}
{% elseif action.name == 'setAttribute' %}
	<span class="action-name">{{ 'set'|trans }}</span> <span class="action-target">{{ targetlib|trans }}</span> <span class="action-data"> {{ 'of «%label%»'|trans({'%label%': simulator.getDataById(action.data).label}) }}</span> <span class="action-value"> {{ 'to'|trans }} {{ simulator.replaceByDataLabel(action.value)|jscode }}</span>
{% elseif action.name == 'unsetAttribute' %}
	<span class="action-name">{{ 'unset'|trans }}</span> <span class="action-target">{{ targetlib|trans }}</span> <span class="action-data"> {{ 'of «%label%»'|trans({'%label%': simulator.getDataById(action.data).label}) }}</span>
{% endif %}
</div>
{% endmacro %}

{% macro showSteps(simulator) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('steps' , 'Steps'|trans, 'primary', '', 'sortable', [{ 'class': 'add-step', 'label': 'Add'|trans, 'icon': 'glyphicon-plus-sign' }] ) }}
{% for step in simulator.steps %}
	{% set buttons = [{ 'class': 'delete-step', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }] %}
	{% if not step.footNotes %}
	{% set buttons = buttons|merge([{ 'label': 'Add'|trans, 'icon': 'glyphicon-plus-sign', 'dropdown': [{ 'class': 'add-panel', 'label': 'Add panel'|trans }, { 'class': 'add-footnotes', 'label': 'Add footnotes'|trans} ] }]) %}
	{% else %}
	{% set buttons = buttons|merge([{ 'class': 'add-panel', 'label': 'Add panel'|trans, 'icon': 'glyphicon-plus-sign' }]) %}
	{% endif %}
	{% set buttons = buttons|merge([{ 'class': 'edit-step', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' }]) %}
	{{ page.openCollapsiblePanel('step-' ~ step.id, 'Step'|trans ~ ' #'~step.id~' : ' ~ step.label, 'info', loop.index == 1 ? 'in' : '', '', buttons ) }}
	<div class="panel panel-default step-container" id="step-{{ step.id }}-attributes-panel" data-id="{{ step.id }}">
		<div class="panel-body">
			<div class="attributes-container">
				<div>
				{{ page.showAttribute('step-'~step.id, 'text', 'name', 'Step Name'|trans, step.name, step.name, true, 'Step Name'|trans) }}
				{{ page.showAttribute('step-'~step.id, 'text', 'label', 'Step Label'|trans, step.label, step.label, true, 'Step Label'|trans) }}
				{{ page.showAttribute('step-'~step.id, 'text', 'template', 'Step Template'|trans, step.template, step.template, true, 'Step Template'|trans) }}
				{{ page.showAttribute('step-'~step.id, 'select', 'output', 'Output'|trans, step.output, step.output, false, 'Select an output', {'normal':'Normal'|trans, 'inlinePDF':'Inline PDF'|trans, 'downloadablePDF':'Downloadable PDF'|trans, 'html':'html'}) }}
				{{ page.showAttribute('step-'~step.id, 'checkbox', 'dynamic', 'Interactive UI'|trans, step.dynamic, step.dynamic, false, 'dynamic') }}
				</div>
			</div>
			<div class="panel panel-default description-panel elements-container" id="step-{{ step.id }}-description-panel">
				<div class="panel-heading">
					{{ 'Description'|trans }}
				</div>
				<div class="panel-body step-description rich-text">
					{{ page.paragraphs(simulator.replaceByDataLabel(step.description)|jscode) }}
				</div>
			</div>
		</div>
	</div>
	<div class="panel panel-default panels-panel" id="step-{{ step.id }}-panels-panel">
		<div class="panel-body sortable">
		{% for panel in step.panels %}
			{{ page.showPanel(step, panel, loop.index == 1 ? 'in' : '') }}
		{% endfor %}
		</div>
	</div>
	{{ page.showActionButtons(step) }}  
	{% if step.footNotes %}
	{{ page.showFootNotes(step) }}  
	{% endif %}
	{{ page.closeCollapsiblePanel() }}  
{% endfor %}
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}

{% macro showFootNotes(step) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('step-' ~ step.id ~ '-footnotes' , 'FootNotes'|trans, 'success', '', '', [{ 'class': 'delete-footnotes', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'add-footnote', 'label': 'Add footnote'|trans, 'icon': 'glyphicon-plus-sign' }, { 'class': 'edit-footnotes', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' }] ) }}
<div class="panel panel-default footnotes-container" id="step-{{ step.id }}-footnotes-attributes-panel" data-step="{{ step.id }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
			{{ page.showAttribute('step-'~step.id~ '-footnotes', 'select', 'position', 'Position'|trans, step.footNotes.position, step.footNotes.position, true, 'Select a position'|trans, { 'beforeActions':'before action buttons'|trans, 'afterActions':'after action buttons'|trans } ) }}
			</div>
		</div>
	</div>
</div>
<div class="footnotes-panel sortable">
{% for footnote in step.footNotes.footNotes %}
{% set footnoteElementId = 'step-'~step.id~'-footnotes-footnote-'~footnote.id %}
<div class="panel panel-default footnote-container" id="{{ footnoteElementId }}-panel" data-step="{{ step.id }}" data-id="{{ footnote.id}}">
	<div class="panel-heading">
		<button class="btn btn-default pull-right update-button delete-footnote" data-parent="#{{ footnoteElementId }}-panel" title="{{ 'Delete'|trans }}"><span class="button-label">{{ 'Delete'|trans }}</span> <span class="glyphicon glyphicon-minus-sign"></span></button>
		<button class="btn btn-default pull-right update-button edit-footnote" data-parent="#{{ footnoteElementId }}-panel" title="{{ 'Edit'|trans }}"><span class="button-label">{{ 'Edit'|trans }}</span> <span class="glyphicon glyphicon-plus-sign"></span></button>
		<h4 class="panel-title">
			{{ 'FootNote #%id%'|trans({'%id%': footnote.id }) }}
		</h4>
	</div>
	<div class="panel-body step-footnote rich-text">
	{{ page.paragraphs(step.simulator.replaceByDataLabel(footnote.text)|jscode) }}
	</div>
</div>
{% endfor %}
</div>
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}

{% macro showActionButtons(step) %}
{% import _self as page %}
<div class="actions-buttons-panel">
{{ page.openCollapsiblePanel('step-' ~ step.id ~ '-action-buttons' , 'Actions Buttons'|trans, 'success', '', 'sortable', [{ 'class': 'add-action-button', 'label': 'Add action button'|trans, 'icon': 'glyphicon-plus-sign' }] ) }}
{% for action in step.actions %}
{{ page.showActionButton(step, action) }}
{% endfor %}
{{ page.closeCollapsiblePanel() }}  
</div>
{% endmacro %}

{% macro showActionButton(step, action) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('step-' ~ step.id ~ '-action-button-' ~ action.name , 'Action Button'|trans ~ ' : ' ~ action.label, 'default', '', '', [{ 'class': 'delete-action-button', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'edit-action-button', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' }] ) }}
<div class="panel panel-default action-button-container" id="step-{{ step.id }}-action-button-{{ action.name }}-attributes-panel" data-step="{{ step.id }}" data-id="{{ action.name }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
			{{ page.showAttribute('step-'~step.id~ '-action-button-' ~ action.name, 'text', 'name', 'Name'|trans, action.name, action.name, true, 'Button name'|trans) }}
			{{ page.showAttribute('step-'~step.id~ '-action-button-' ~ action.name, 'text', 'label', 'Label'|trans, action.label, action.label, true, 'Button label'|trans) }}
			{{ page.showAttribute('step-'~step.id~ '-action-button-' ~ action.name, 'select', 'what', 'What'|trans, action.what, action.what, true, 'Select an action'|trans, { 'submit':'Submit'|trans, 'reset':'Reset'|trans } ) }}
			{{ page.showAttribute('step-'~step.id~ '-action-button-' ~ action.name, 'select', 'for', 'For'|trans, action.for, action.for, true, 'Select a target step'|trans, { 'priorStep':'Prior step'|trans, 'currentStep':'Current step'|trans, 'nextStep':'Next step'|trans, 'jumpToStep':'Jump to step'|trans, 'newSimulation':'New simulation'|trans, 'externalPage':'External page'|trans } ) }}
			{{ page.showAttribute('step-'~step.id~ '-action-button-' ~ action.name, 'text', 'uri', 'URI / Step'|trans, action.uri, action.uri, false, 'Button uri'|trans) }}
			{{ page.showAttribute('step-'~step.id~ '-action-button-' ~ action.name, 'select', 'class', 'Class'|trans, action.class, action.class, false, 'Button class'|trans, { 'btn-primary':'Primary'|trans, 'btn-default':'Secondary'|trans } ) }}
			</div>
		</div>
	</div>
</div>
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}

{% macro showSources(simulator) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('sources' , 'Used datasources'|trans, 'primary', '', 'sortable', [{ 'class': 'add-source', 'label': 'Add'|trans, 'icon': 'glyphicon-plus-sign' }] ) }}
{% for source in simulator.sources %}
	{{ page.showSource(simulator, source, 'source', loop.index == 1 ? 'in' : '') }}
{% endfor %}
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}

{% macro showSource(simulator, source, containerType, inClass) %}
{% import _self as page %}
{% set datasource = simulator.datasourceByName(source.datasource) %}
{{ page.openCollapsiblePanel('source-' ~ source.id , '#' ~ source.id ~ ' ' ~ source.label, 'info', inClass, '', [{ 'class': 'delete-source', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'edit-source', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' } ] ) }}
<div class="panel panel-default {{ containerType }}-container" id="source-{{ source.id }}-attributes-panel" data-id="{{ source.id }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
			{{ page.showAttribute('source-' ~ source.id, 'text', 'label', 'Label'|trans, source.label, source.label, false, 'Source label'|trans) }}
			{{ page.showAttribute('source-' ~ source.id, 'text', 'datasource', 'Datasource'|trans, source.datasource, source.datasource, true, 'Datasource'|trans) }}
			{% if datasource.type != 'uri' %}
				{{ page.showAttribute('source-'~source.id, 'select', 'requestType', 'Request type'|trans, source.requestType, source.requestType, false, 'Select a request type'|trans, { 'simple':'Simple'|trans, 'complex':'Complex'|trans } ) }}
				{% if source.requestType == 'simple' and source.parsed != ''%}
				{{ page.showAttribute('source-'~source.id, 'text', 'table', 'Table'|trans, source.parsed.from.table, '«' ~ source.parsed.from.label ~ '»', false, 'Table'|trans) }}
				<div class="form-group col-sm-12">
					<label class="col-sm-4 control-label">{{ 'Selected columns'|trans }}</label>
					<div class="col-sm-8">
						<p data-attribute="columns" data-value="" class="form-control-static simple-value">
							{% for col in source.parsed.select %}
							{% if loop.index > 1 %}
							<span>, </span>
							{% endif %}
							<span data-attribute="column" data-value="{{ col.column }}" data-alias="{{ col.alias }}">
							{% if col.alias and col.alias != '' and col.alias|lower != col.column|lower %}
							{{ '«' ~ col.label ~ '» ' ~ 'alias'|trans ~ ' ' ~ col.alias }}
							{% else %}
							{{ '«' ~ col.label ~ '»' }}
							{% endif %}
							</span>
							{% endfor %}
						</p>
					</div>
				</div>
				{% if source.parsed.where == 'true' %}
				{{ page.showAttribute('source-'~source.id, 'text', 'filter', 'Filter'|trans, source.parsed.where|url_encode, 'No filter'|trans, false, 'Filter'|trans) }}
				{% else %}
				{{ page.showAttribute('source-'~source.id, 'text', 'filter', 'Filter'|trans, source.parsed.where|url_encode, source.parsed.where, false, 'Filter'|trans) }}
				{% endif %}
				<div class="form-group col-sm-12">
					<label class="col-sm-4 control-label">{{ 'Order by'|trans }}</label>
					<div class="col-sm-8">
						<p data-attribute="orderbykeys" data-value="" class="form-control-static simple-value">
							{% if source.parsed.orderby is not empty %}
							{% for col in source.parsed.orderby %}
							{% if loop.index > 1 %}
							<span>, </span>
							{% endif %}
							<span data-attribute="orderbykey" data-value="{{ col.key }}" data-order="{{ col.order }}">
							{% if col.order == 'desc' %}
							{{ '«' ~ col.label ~ '» ' ~ 'in descending order'|trans }}
							{% else %}
							{{ '«' ~ col.label ~ '» ' ~ 'in ascending order'|trans }}
							{% endif %}
							</span>
							{% endfor %}
							{% endif %}
						</p>
					</div>
				</div>
				{% if source.parsed.limit == 0 %}
				{{ page.showAttribute('source-'~source.id, 'number', 'nbresult', 'Number of results'|trans, source.parsed.limit, 'All results'|trans, false, 'Number of results'|trans) }}
				{% else %}
				{{ page.showAttribute('source-'~source.id, 'number', 'nbresult', 'Number of results'|trans, source.parsed.limit, source.parsed.limit, false, 'Number of results'|trans) }}
				{% endif %}
				{% if source.parsed.offset == 0 %}
				{{ page.showAttribute('source-'~source.id, 'number', 'from', 'From'|trans, source.parsed.offset, 'from start'|trans, false, 'From'|trans) }}
				{% else %}
				{{ page.showAttribute('source-'~source.id, 'number', 'from', 'From'|trans, source.parsed.offset, source.parsed.offset, false, 'From'|trans) }}
				{% endif %}
				{% else %}
				{{ page.showAttribute('source-'~source.id, 'text', 'request', 'Request'|trans, source.request|url_encode, source.request, false, 'Request'|trans) }}
				{% endif %}
			{% endif %}
			{{ page.showAttribute('source-'~source.id, 'select', 'returnType', 'Return type'|trans, source.returnType, source.returnType, true, 'Select a return type'|trans, { 'json':'JSON'|trans, 'xml':'XML'|trans, 'singleValue':'Single value'|trans, 'assocArray':'Associative array'|trans, 'html':'HTML'|trans, 'csv':'Comma separated value (csv)'|trans } ) }}
			{{ page.showAttribute('source-'~source.id, 'text', 'returnPath', 'Return path'|trans, source.returnPath, source.returnPath, false, 'Return path'|trans) }}
			{% if source.returnType == 'csv' %}
			{{ page.showAttribute('source-'~source.id, 'text', 'separator', 'Separator'|trans, source.separator, source.separator, false, 'Separator'|trans) }}
			{{ page.showAttribute('source-'~source.id, 'text', 'delimiter', 'Delimiter'|trans, source.delimiter, source.delimiter, false, 'Delimiter'|trans) }}
			{% endif %}
			</div>
		</div>
	</div>
</div>
{% if source.parameters is not empty %}
<div class="panel panel-default source-parameters-panel" id="source-{{ source.id }}-source-parameters-panel">
	<div class="panel-heading">
		{{ 'Parameters'|trans }}
	</div>
	<div class="panel-body">
		{% for parameter in source.parameters %}
		{% set paramId = loop.index %}
		<div class="panel panel-default source-parameter-container" data-id="{{ paramId }}">
			<div class="panel-heading">
				{{ 'Parameter %id%'|trans({ '%id%' : paramId }) }}
			</div>
			<div class="panel-body" id="source-{{ source.id }}-source-parameter-{{ paramId }}-panel">
				<div class="attributes-container">
					<div>
						{% if datasource.type == 'uri' %}
						{{ page.showAttribute('source-'~source.id~'-source-parameter-'~paramId, 'select', 'type', 'Type'|trans, parameter.type, parameter.type, true, 'Select a type'|trans, { 'queryString':'Query string parameter'|trans, 'path':'PATH'|trans, 'data':'POST data'|trans, 'columnValue':'Column value'|trans, 'header':'HTTP header'|trans } ) }}
						{% endif %}
						{{ page.showAttribute('source-'~source.id~'-source-parameter-'~paramId, 'text', 'name', 'Name'|trans, parameter.name, parameter.name, false, 'Parameter name'|trans) }}
						{{ page.showAttribute('source-'~source.id~'-source-parameter-'~paramId, 'select', 'origin', 'Origin'|trans, parameter.origin, parameter.origin, true, 'Select an origin'|trans, { 'data':'Data'|trans, 'constant':'Constant'|trans } ) }}
						{% if parameter.origin == 'data' %}
						{% set data = simulator.dataById(parameter.data) %}
						<div class="form-group col-sm-12">
							<label class="col-sm-4 control-label">{{ 'Data'|trans }}</label>
							<div class="col-sm-8">
								<p data-attribute="data" data-value="{{ data.name }}" class="form-control-static simple-value">{{ data.label }}</p>
							</div>
						</div>
						{% if data.type == 'date' or data.type == 'day' or data.type == 'month' or data.type == 'year' %}
						{{ page.showAttribute('source-'~source.id~'-source-parameter-'~paramId, 'text', 'format', 'Format'|trans, parameter.format, parameter.format|trans, false, 'Date format of the parameter'|trans) }}
						{% endif %}
						{% else %}
						{{ page.showAttribute('source-'~source.id~'-source-parameter-'~paramId, 'text', 'constant', 'Constant'|trans, parameter.constant, parameter.constant, false, 'Constant value of the parameter'|trans) }}
						{% endif %}
						{{ page.showAttribute('source-'~source.id~'-source-parameter-'~paramId, 'checkbox', 'optional', 'Optional'|trans, parameter.optional, parameter.optional, false, 'Optional'|trans) }}
					</div>
				</div>
			</div>
		</div>
		{% endfor %}
	</div>
</div>
{% endif %}
{{ page.closeCollapsiblePanel() }}
{% endmacro %}

{% macro showPanel(step, panel, inClass) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('step-' ~ step.id ~ '-panel-' ~ panel.id , 'Panel'|trans ~ ' #' ~ panel.id ~ ' : ' ~ panel.label, 'success', inClass, '', [{ 'class': 'delete-panel', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'label': 'Add'|trans, 'icon': 'glyphicon-plus-sign', 'dropdown': [{ 'class': 'add-fieldset', 'label': 'Add fieldset'|trans }, { 'class': 'add-blockinfo', 'label': 'Add blockinfo'|trans} ] }, { 'class': 'edit-panel', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' } ] ) }}
<div class="panel panel-default panel-container" id="step-{{ step.id }}-panel-{{ panel.id }}-attributes-panel" data-step="{{ step.id }}" data-id="{{ panel.id }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id, 'text', 'name', 'Name'|trans, panel.name, panel.name, true, 'Panel name'|trans) }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id, 'text', 'label', 'Label'|trans, panel.label, panel.label, true, 'Panel label'|trans) }}
			</div>
		</div>
	</div>
</div>
<div class="panel panel-default blocks-panel" id="step-{{ step.id }}-panel-{{ panel.id }}-blocks-panel">
	<div class="panel-body sortable">
	{% for blck in panel.fieldSets %}
		{% if blck.class == "FieldSet" %}
		{{ page.showFieldSet(step, panel, blck, loop.index == 1 ? 'in' : '') }}
		{% elseif blck.class == 'BlockInfo' %}
		{{ page.showBlockInfo(step, panel, blck, loop.index == 1 ? 'in' : '') }}
		{% endif %}
	{% endfor %}
	</div>
</div>
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}

{% macro showFieldSet(step, panel, fieldset, inClass) %}
{% import _self as page %}
{% if fieldset.disposition == "grid" %}
{{ page.openCollapsiblePanel('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id , 'FieldSet'|trans ~ ' #' ~ fieldset.id ~ ' : ' ~  fieldset.legend|striptags, 'info', inClass, '', [{ 'class': 'delete-fieldset', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'edit-fieldset', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' } ] ) }}
{% else %}
{{ page.openCollapsiblePanel('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id , 'FieldSet'|trans ~ ' #' ~ fieldset.id ~ ' : ' ~  fieldset.legend|striptags, 'info', inClass, '', [{ 'class': 'delete-fieldset', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'add-field', 'label': 'Add field'|trans, 'icon': 'glyphicon-plus-sign' }, { 'class': 'edit-fieldset', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' } ] ) }}
{% endif %}
<div class="panel panel-default block-container fieldset" id="step-{{ step.id }}-panel-{{ panel.id }}-fieldset-{{ fieldset.id }}-attributes-panel" data-step="{{ step.id }}" data-panel="{{ panel.id }}" data-id="{{ fieldset.id }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id, 'select', 'disposition', 'Disposition'|trans, fieldset.disposition, fieldset.disposition, false, 'Select a Disposition'|trans, {'classic':'Classic'|trans, 'grid':'Grid'|trans, 'inline':'Inline'|trans}) }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id, 'select', 'display', 'Display'|trans, fieldset.display, fieldset.display, false, 'Select a Display'|trans, {'inline':'Inline'|trans, 'pop-in':'Pop-in'|trans}) }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id, 'text', 'popinLink', 'Pop-in Link'|trans, fieldset.popinLink, fieldset.popinLink, false, 'Pop-in Link'|trans) }}
			</div>
		</div>
		<div class="panel panel-default legend-panel elements-container" id="step-{{ step.id }}-panel-{{ panel.id }}-fieldset-{{ fieldset.id }}-legend-panel">
			<div class="panel-heading">
			{{ 'Legend'|trans }}
			</div>
			<div class="panel-body fieldset-legend rich-text">
				{{ page.paragraphs(step.simulator.replaceByDataLabel(fieldset.legend)|jscode) }}
			</div>
		</div>
	</div>
</div>
{% if fieldset.disposition == "grid" %}
<div class="panel panel-default fieldset-grid-panel" id="fieldset-{{ fieldset.id }}-fieldset-grid-panel">
	<div class="panel-heading">
		<button class="btn btn-default pull-right update-button add-column" data-parent="#fieldset-{{ fieldset.id }}-fieldset-grid-panel" title="{{ 'Add column'|trans }}"><span class="button-label">{{ 'Add column'|trans }}</span> <span class="glyphicon glyphicon-plus-sign"></span></button>
		<button class="btn btn-default pull-right update-button add-fieldrow" data-parent="#fieldset-{{ fieldset.id }}-fieldset-grid-panel" title="{{ 'Add fieldrow'|trans }}"><span class="button-label">{{ 'Add fieldrow'|trans }}</span> <span class="glyphicon glyphicon-plus-sign"></span></button>
		<h4 class="panel-title">
			{{ 'Grid'|trans }}
		</h4>
	</div>
	<div class="panel-body">
		<div class="panel panel-default columns-panel" id="step-{{ step.id }}-panel-{{ panel.id }}-fieldset-{{ fieldset.id }}-columns-panel">
			<div class="panel-body sortable">
			{% for column in fieldset.columns %}
			{{ page.showFieldSetColumn(step, panel, fieldset, column, loop.index == 1 ? 'in' : '') }}
			{% endfor %}
			</div>
		</div>
		<div class="panel panel-default fieldrows-panel" id="step-{{ step.id }}-panel-{{ panel.id }}-fieldset-{{ fieldset.id }}-fieldrows-panel">
			<div class="panel-body sortable">
			{% for fieldrow in fieldset.fields %}
			{{ page.showFieldrow(step, panel, fieldset, fieldrow, loop.index, loop.index == 1 ? 'in' : '') }}
			{% endfor %}
			</div>
		</div>
	</div>
</div>
{% else %}
<div class="panel panel-default fields-panel" id="step-{{ step.id }}-panel-{{ panel.id }}-fieldset-{{ fieldset.id }}-fields-panel">
	<div class="panel-body sortable">
	{% for field in fieldset.fields %}
	{{ page.showField(step, panel, fieldset, null, field, loop.index == 1 ? 'in' : '') }}
	{% endfor %}
	</div>
</div>
{% endif %}
{{ page.closeCollapsiblePanel() }}
{% endmacro %}

{% macro showFieldSetColumn(step, panel, fieldset, column, inClass) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id ~ '-column-' ~ column.id , 'Column #%id% : %label%'|trans({ '%id%': column.id, '%label%': column.label }), 'warning', inClass, '', [{ 'class': 'delete-column', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'edit-column', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' } ] ) }}
<div class="panel panel-default column-container" id="step-{{ step.id }}-panel-{{ panel.id }}-fieldset-{{ fieldset.id }}-column-{{ column.id }}-attributes-panel" data-step="{{ step.id }}" data-panel="{{ panel.id }}" data-fieldset="{{ fieldset.id }}" data-id="{{ column.id }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id ~ '-column-' ~ column.id, 'text', 'name', 'Name'|trans, column.name, column.name, true, 'Column name'|trans) }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id ~ '-column-' ~ column.id, 'text', 'label', 'Label'|trans, column.label, column.label, true, 'Column label'|trans) }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id ~ '-column-' ~ column.id, 'select', 'type', 'Type'|trans, column.type, column.type, true, 'Select a type'|trans, {'array':'liste'|trans, 'date':'date'|trans, 'day':'day'|trans, 'month':'month'|trans, 'year':'year'|trans, 'boolean':'boolean'|trans, 'integer':'integer'|trans, 'number':'number'|trans, 'text':'text'|trans, 'textarea':'textarea'|trans, 'money':'money'|trans, 'choice':'choice'|trans, 'multichoice':'multichoice'|trans, 'percent':'percent'|trans, 'table':'table'|trans, 'department':'department'|trans, 'region':'region'|trans, 'country':'country'|trans}) }}
			</div>
		</div>
	</div>
</div>
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}

{% macro showFieldrow(step, panel, fieldset, fieldrow, inClass) %}
{% import _self as page %}
{% if fieldrow.fields|length < fieldset.columns|length %}
{{ page.openCollapsiblePanel('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id ~ '-fieldrow-' ~ fieldrow.id , 'Fieldrow #%id% : %label%'|trans({ '%id%': fieldrow.id, '%label%': fieldrow.label }), 'success', inClass, '', [{ 'class': 'delete-fieldrow', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'add-field', 'label': 'Add field'|trans, 'icon': 'glyphicon-plus-sign' }, { 'class': 'edit-fieldrow', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' } ] ) }}
{% else %}
{{ page.openCollapsiblePanel('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id ~ '-fieldrow-' ~ fieldrow.id , 'Fieldrow #%id% : %label%'|trans({ '%id%': fieldrow.id, '%label%': fieldrow.label }), 'success', inClass, '', [{ 'class': 'delete-fieldrow', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'edit-fieldrow', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' } ] ) }}
{% endif %}
<div class="panel panel-default fieldrow-container" id="step-{{ step.id }}-panel-{{ panel.id }}-fieldset-{{ fieldset.id }}-fieldrow-{{ fieldrow.id }}-attributes-panel" data-step="{{ step.id }}" data-panel="{{ panel.id }}" data-fieldset="{{ fieldset.id }}" data-id="{{ fieldrow.id }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id ~ '-fieldrow-' ~ fieldrow.id, 'text', 'label', 'Label'|trans, fieldrow.label, fieldrow.label, true, 'Fieldrow label'|trans) }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id ~ '-fieldrow-' ~ fieldrow.id, 'checkbox', 'colon', 'Show colon after field label ?'|trans, fieldrow.colon, fieldrow.colon, false, 'colon') }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id ~ '-fieldrow-' ~ fieldrow.id, 'checkbox', 'help', 'Show data description as help ?'|trans, fieldrow.help, fieldrow.help, false, 'help') }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id ~ '-fieldrow-' ~ fieldrow.id, 'checkbox', 'emphasize', 'Emphasize the text label ?'|trans, fieldrow.emphasize, fieldrow.emphasize, false, 'emphasize') }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id ~ '-fieldrow-' ~ fieldrow.id, 'text', 'datagroup', 'Datagroup'|trans, fieldrow.fieldset.panel.step.simulator.getDataGroupById(fieldrow.datagroup).label, fieldrow.fieldset.panel.step.simulator.getDataGroupById(fieldrow.datagroup).label, true, 'Datagroup'|trans) }}
			</div>
		</div>
	</div>
</div>
<div class="panel panel-default fields-panel" id="step-{{ step.id }}-panel-{{ panel.id }}-fieldset-{{ fieldset.id }}-fieldrow-{{ fieldrow.id }}-fields-panel">
	<div class="panel-body sortable">
	{% for field in fieldrow.fields %}
	{{ page.showField(step, panel, fieldset, fieldrow, field, loop.index == 1 ? 'in' : '') }}
	{% endfor %}
	</div>
</div>
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}

{% macro showField(step, panel, fieldset, fieldrow, field, inClass) %}
{% import _self as page %}
{% if fieldset.disposition == 'grid' %}
{% set elementId = 'step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id ~ '-fieldrow-' ~ fieldrow.id ~ '-field-' ~ field.position %}
{% set fieldrowId = fieldrow.id %}
{% else %}
{% set elementId = 'step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-fieldset-' ~ fieldset.id ~ '-field-' ~ field.position %}
{% set fieldrowId = '' %}
{% endif %}
{{ page.openCollapsiblePanel(elementId , 'Field'|trans ~ ' #' ~ field.position ~ ' : ' ~ field.label, 'warning', inClass, '', [{ 'class': 'delete-field', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'edit-field', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' } ] ) }}
<div class="panel panel-default field-container" id="{{ elementId }}-attributes-panel" data-step="{{ step.id }}" data-panel="{{ panel.id }}" data-fieldset="{{ fieldset.id }}" data-fieldrow="{{ fieldrowId }}" data-id="{{ field.position }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
			{{ page.showAttribute(elementId, 'text', 'data', 'Data'|trans, field.fieldset.panel.step.simulator.getDataById(field.data).label, field.fieldset.panel.step.simulator.getDataById(field.data).label, true, 'Field data'|trans) }}
			{{ page.showAttribute(elementId, 'text', 'label', 'Label'|trans, field.label, field.label, false, 'Field label'|trans) }}
			{{ page.showAttribute(elementId, 'select', 'usage', 'Usage'|trans, field.usage, field.usage, true, 'Select an usage'|trans, {'input':'input'|trans, 'output':'output'|trans}) }}
			{{ page.showAttribute(elementId, 'text', 'prompt', 'Prompt'|trans, field.prompt, field.prompt, false, 'Field prompt'|trans) }}
			{{ page.showAttribute(elementId, 'checkbox', 'required', 'Required'|trans, field.required, field.required, false, 'required') }}
			{{ page.showAttribute(elementId, 'checkbox', 'visibleRequired', 'Required if visible'|trans, field.visibleRequired, field.visibleRequired, false, 'visibleRequired') }}
			{{ page.showAttribute(elementId, 'checkbox', 'newline', 'Newline before field ?'|trans, field.newline, field.newline, false, 'newline') }}
			{{ page.showAttribute(elementId, 'checkbox', 'colon', 'Show colon after field label ?'|trans, field.colon, field.colon, false, 'colon') }}
			{{ page.showAttribute(elementId, 'checkbox', 'underlabel', 'Place the field under the label ?'|trans, field.underlabel, field.underlabel, false, 'underlabel') }}
			{{ page.showAttribute(elementId, 'checkbox', 'help', 'Show data description as help ?'|trans, field.help, field.help, false, 'help') }}
			{{ page.showAttribute(elementId, 'checkbox', 'emphasize', 'Emphasize the text label ?'|trans, field.emphasize, field.emphasize, false, 'emphasize') }}
			{{ page.showAttribute(elementId, 'checkbox', 'expanded', 'Show choices as radio buttons ?'|trans, field.expanded, field.expanded, false, 'expanded') }}
			{{ page.showAttribute(elementId, 'text', 'explanation', 'Explanation'|trans, field.explanation, field.explanation, false, 'Explanation'|trans) }}
			{{ page.showAttribute(elementId, 'select', 'widget', 'Widget'|trans, field.widget, field.widget, false, 'Select a widget'|trans, step.simulator.controller.helper.widgets) }}
			</div>
		</div>
		{% if field.preNote %}
		<div class="panel panel-default note-panel elements-container" id="{{ elementId }}-note-panel">
			<div class="panel-heading">
				<span class="note-position pull-right">{{ 'Note position'|trans }} : {{ 'placed before the field'|trans }}</span> 
				{{ 'Note'|trans }}
			</div>
			<div class="panel-body field-note rich-text">
			{{ page.paragraphs(step.simulator.replaceByDataLabel(field.preNote.text)|jscode) }}
			</div>
		</div>
		{% elseif field.postNote %}
		<div class="panel panel-default note-panel elements-container" id="{{ elementId }}-note-panel">
			<div class="panel-heading">
				<span class="note-position pull-right">{{ 'Note position'|trans }} : {{ 'placed after the field'|trans }}</span> 
				{{ 'Note'|trans }}
			</div>
			<div class="panel-body field-note rich-text">
			{{ page.paragraphs(step.simulator.replaceByDataLabel(field.postNote.text)|jscode) }}
			</div>
		</div>
		{% endif %}
	</div>
</div>
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}

{% macro showBlockInfo(step, panel, blockinfo, inClass) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-blockinfo-' ~ blockinfo.id , 'Blockinfo #%id% : %label%'|trans({'%id%': blockinfo.id, '%label%': blockinfo.label }), 'info', inClass, '', [{ 'class': 'delete-blockinfo', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'add-chapter', 'label': 'Add chapter'|trans, 'icon': 'glyphicon-plus-sign' }, { 'class': 'edit-blockinfo', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' } ] ) }}
<div class="panel panel-default block-container blockinfo" id="step-{{ step.id }}-panel-{{ panel.id }}-blockinfo-{{ blockinfo.id }}-attributes-panel" data-step="{{ step.id }}" data-panel="{{ panel.id }}" data-id="{{ blockinfo.id }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-blockinfo-' ~ blockinfo.id, 'text', 'name', 'Name'|trans, blockinfo.name, blockinfo.name, true, 'Blockinfo name'|trans) }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-blockinfo-' ~ blockinfo.id, 'text', 'label', 'Label'|trans, blockinfo.label, blockinfo.label, true, 'Blockinfo label'|trans) }}
			</div>
		</div>
	</div>
</div>
<div class="panel panel-default chapters-panel" id="step-{{ step.id }}-panel-{{ panel.id }}-blockinfo-{{ blockinfo.id }}-chapters-panel">
	<div class="panel-body sortable">
	{% for chapter in blockinfo.chapters %}
	{{ page.showChapter(step, panel, blockinfo, chapter, loop.index == 1 ? 'in' : '') }}
	{% endfor %}
	</div>
</div>
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}

{% macro showChapter(step, panel, blockinfo, chapter, inClass) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-blockinfo-' ~ blockinfo.id ~ '-chapter-' ~ chapter.id , 'Chapter #%id% : %label%'|trans({'%id%': chapter.id, '%label%': chapter.label }), 'warning', inClass, '', [{ 'class': 'delete-chapter', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'add-section', 'label': 'Add section'|trans, 'icon': 'glyphicon-plus-sign' }, { 'class': 'edit-chapter', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' } ] ) }}
<div class="panel panel-default chapter-container" id="step-{{ step.id }}-panel-{{ panel.id }}-blockinfo-{{ blockinfo.id }}-chapter-{{ chapter.id }}-attributes-panel" data-step="{{ step.id }}" data-panel="{{ panel.id }}" data-blockinfo="{{ blockinfo.id }}" data-id="{{ chapter.id }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-blockinfo-' ~ blockinfo.id ~ '-chapter-' ~ chapter.id, 'text', 'name', 'Name'|trans, chapter.name, chapter.name, true, 'Chapter name'|trans) }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-blockinfo-' ~ blockinfo.id ~ '-chapter-' ~ chapter.id, 'text', 'label', 'Label'|trans, chapter.label, chapter.label, true, 'Chapter label'|trans) }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-blockinfo-' ~ blockinfo.id ~ '-chapter-' ~ chapter.id, 'text', 'icon', 'Icon'|trans, chapter.icon, chapter.icon, false, 'Chapter icon'|trans) }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-blockinfo-' ~ blockinfo.id ~ '-chapter-' ~ chapter.id, 'checkbox', 'collapsible', 'Allow collapse/expand ?'|trans, chapter.collapsible, chapter.collapsible, false, 'collapsible') }}
			</div>
		</div>
	</div>
</div>
<div class="panel panel-default sections-panel" id="step-{{ step.id }}-panel-{{ panel.id }}-blockinfo-{{ blockinfo.id }}-chapter-{{ chapter.id }}-sections-panel">
	<div class="panel-body sortable">
	{% for section in chapter.sections %}
	{{ page.showSection(step, panel, blockinfo, chapter, section, loop.index == 1 ? 'in' : '') }}
	{% endfor %}
	</div>
</div>
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}


{% macro showSection(step, panel, blockinfo, chapter, section, inClass) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-blockinfo-' ~ blockinfo.id ~ '-chapter-' ~ chapter.id ~ '-section-' ~ section.id , 'Section #%id% : %label%'|trans({ '%id%': section.id, '%label%': section.label }), 'info', inClass, '', [{ 'class': 'delete-section', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'edit-section', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' } ] ) }}
<div class="panel panel-default section-container" id="step-{{ step.id }}-panel-{{ panel.id }}-blockinfo-{{ blockinfo.id }}-chapter-{{ chapter.id }}-section-{{ section.id }}-attributes-panel" data-step="{{ step.id }}" data-panel="{{ panel.id }}" data-blockinfo="{{ blockinfo.id }}" data-chapter="{{ chapter.id }}" data-id="{{ section.id }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-blockinfo-' ~ blockinfo.id ~ '-chapter-' ~ chapter.id ~ '-section-' ~ section.id, 'text', 'name', 'Name'|trans, section.name, section.name, true, 'Section name'|trans) }}
			{{ page.showAttribute('step-' ~ step.id ~ '-panel-' ~ panel.id ~ '-blockinfo-' ~ blockinfo.id ~ '-chapter-' ~ chapter.id ~ '-section-' ~ section.id, 'text', 'label', 'Label'|trans, section.label, section.label, false, 'Section label'|trans) }}
			</div>
		</div>
	</div>
</div>
<div class="panel panel-default content-panel" id="step-{{ step.id }}-panel-{{ panel.id }}-blockinfo-{{ blockinfo.id }}-chapter-{{ chapter.id }}-section-{{ section.id }}-content-panel">
	<div class="panel-heading">
		{{ 'Content'|trans }}
	</div>
	<div class="panel-body section-content rich-text">
		{{ page.paragraphs(step.simulator.replaceByDataLabel(section.content)|jscode) }}
	</div>
</div>
<div class="panel panel-default annotations-panel" id="step-{{ step.id }}-panel-{{ panel.id }}-blockinfo-{{ blockinfo.id }}-chapter-{{ chapter.id }}-section-{{ section.id }}-annotations-panel">
	<div class="panel-heading">
		{{ 'Annotations'|trans }}
	</div>
	<div class="panel-body section-annotations rich-text">
		{{ page.paragraphs(step.simulator.replaceByDataLabel(section.annotations)|jscode) }}
	</div>
</div>
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}


{% macro showAttribute(element, type, name, label, value, display, required, placeholder, options) %}
{% if required or value is not empty %}
<div class="form-group col-sm-12">
	<label class="col-sm-4 control-label">{{ label }}</label>
	<div class="col-sm-8">
		{% if type == 'text' or type == 'number' %}
		<p data-attribute="{{ name }}" data-value="{{ value }}" class="form-control-static simple-value">{{ display }}</p>
		{% elseif type == 'checkbox' %}
		<p data-attribute="{{ name }}" class="form-control-static simple-value" data-value="{%- if value -%}1{%- else -%}0{%- endif -%}">{%- if value -%}{{ 'Yes'|trans }}{%- else -%}{{ 'No'|trans }}{%- endif -%}</p>
		{% elseif type == 'select' %}
			{% for val, option in options %}
			{%- if value == val %}
			<p data-attribute="{{ name }}" data-value="{{ value }}" class="form-control-static simple-value">{{ option }}</p>
			{%- endif -%}
			{% endfor %}
		{% endif %}
	</div>
</div>
{% endif %}
{% endmacro %}
 
{% macro showExpressionAttribute(element, name, label, value, plainvalue, required, placeholder) %}
{% if required or value is not empty %}
<div class="form-group col-sm-12">
	<label class="col-sm-4 control-label">{{ label }}</label>
	<span data-attribute="{{ name }}" class="attribute-expression" data-placeholder="{{ placeholder }}"  data-value="{{ value }}">{{ plainvalue }}</span>
</div>
{% endif %}
{% endmacro %}

{% macro openCollapsiblePanel(id, header, style, in, sortable, buttons) %}
<div class="panel-group" id="{{ id }}" role="tablist" aria-multiselectable="true">
	<div class="panel panel-{{ style }}">
		<div class="panel-heading" role="tab" id="{{ id }}-panel">
			{% if buttons is not empty %}
			{% for button in buttons %}
			{% if button.dropdown is defined and button.dropdown is not empty%}
			<div class="btn-group pull-right update-button">
				<button class="btn btn-{{ style }} dropdown-toggle" title="{{ button.label }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					<span class="button-label">{{ button.label }}</span> <span class="glyphicon {{ button.icon }}"></span>
				</button>
				<ul class="dropdown-menu">
					{% for item in button.dropdown %}
					<li>
						<a href="#" class="{{ item.class }}" data-parent="#{{ id }}" title="{{ item.label }}">{{ item.label }}</a>
					</li>
					{% endfor %}
				</ul>
			</div>
			{% else %}
			<button class="btn btn-{{ style }} pull-right update-button {{ button.class }}" data-parent="#{{ id }}" title="{{ button.label }}"><span class="button-label">{{ button.label }}</span> <span class="glyphicon {{ button.icon }}"></span></button>
			{% endif %}
			{% endfor %}
			{% endif %}
			{% if style == 'primary' %}
			<button class="btn btn-{{ style }} pull-right expand-all toggle-collapse-all" data-parent="#{{ id }}" title="{{ 'Expand all'|trans }}"><span class="button-label">{{'Expand all'|trans }}</span> <span class="glyphicon glyphicon-expand"></span></button>
			{% endif %}
			<h4 class="panel-title">
				<a data-toggle="collapse" data-parent="#{{ id }}" href="#collapse{{ id }}" aria-expanded="true" aria-controls="collapse{{ id }}">
					{{ header }}
				</a>
			</h4>
		</div>
		<div id="collapse{{ id }}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{ id }}-panel">
			<div class="panel-body {{ sortable }}">
{% endmacro %}

{% macro closeCollapsiblePanel() %}
			</div>
		</div>
	</div>
</div>
{% endmacro %}

{% macro showData(data, datagroup, containerType, inClass) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('data-' ~ data.id, '#'~data.id~' : '~data.label, 'info', inClass, '', [{ 'class': 'delete-data', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'edit-data', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' } ] ) }}
<div class="panel panel-default {{ containerType }}-container" id="data-{{ data.id }}-attributes-panel" data-datagroup="{{ datagroup }}" data-id="{{ data.id }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
			{{ page.showAttribute('data-'~data.id, 'text', 'name', 'Name'|trans, data.name, data.name, true, 'Data name'|trans) }}
			{{ page.showAttribute('data-'~data.id, 'text', 'label', 'Label'|trans, data.label, data.label, true, 'Data label'|trans) }}
			{{ page.showAttribute('data-'~data.id, 'select', 'type', 'Type'|trans, data.type, data.type, true, 'Select a type'|trans, {'array':'liste'|trans, 'date':'date'|trans, 'day':'day'|trans, 'month':'month'|trans, 'year':'year'|trans, 'boolean':'boolean'|trans, 'integer':'integer'|trans, 'number':'number'|trans, 'text':'text'|trans, 'textarea':'textarea'|trans, 'money':'money'|trans, 'choice':'choice'|trans, 'multichoice':'multichoice'|trans, 'percent':'percent'|trans, 'table':'table'|trans, 'department':'department'|trans, 'region':'region'|trans, 'country':'country'|trans}) }}
			{{ page.showExpressionAttribute('data-'~data.id, 'default', 'Default'|trans, data.unparsedDefault, data.plainDefault, false, 'default value'|trans) }}
			{{ page.showExpressionAttribute('data-'~data.id, 'min', 'Min'|trans, data.unparsedMin, data.plainMin, false, 'Minimum value'|trans) }}
			{{ page.showExpressionAttribute('data-'~data.id, 'max', 'Max'|trans, data.unparsedMax, data.plainMax, false, 'Maximum value'|trans) }}
			{{ page.showExpressionAttribute('data-'~data.id, 'content', 'Content'|trans, data.content, data.plainContent, false, 'Content'|trans) }}
			{% if data.round != '2' %}
			{{ page.showAttribute('data-'~data.id, 'number', 'round', 'Round'|trans, data.round, data.round, false, 'Round'|trans) }}
			{% endif %}
			{{ page.showAttribute('data-'~data.id, 'text', 'unit', 'Unit'|trans, data.unit, data.unit, false, 'Unit'|trans) }}
			{% if data.source is not empty %}
			{% set sourceLabel = data.simulator.sourceById(data.source).label %}
			{% if sourceLabel is empty %}
			{% set sourceLabel = data.source %}
			{% endif %}
			{{ page.showAttribute('data-'~data.id, 'number', 'source', 'Source'|trans, data.source, sourceLabel, false, 'Source'|trans) }}
			{% endif %}
			{{ page.showAttribute('data-'~data.id, 'text', 'index', 'Index'|trans, data.unparsedIndex, data.unparsedIndex, false, 'Index'|trans) }}
			{{ page.showAttribute('data-'~data.id, 'checkbox', 'memorize', 'Memorize'|trans, data.memorize, data.memorize, false, 'Memorize'|trans) }}
			</div>
		</div>
	</div>
</div>
<div class="panel panel-default description-panel" id="data-{{ data.id }}-description-panel">
	<div class="panel-heading">
		{{ 'Description'|trans }}
	</div>
	<div class="panel-body data-description rich-text">
		{{ page.paragraphs(data.simulator.replaceByDataLabel(data.description)|jscode) }}
	</div>
</div>
{% if data.choices is not empty or data.choiceSource is not empty %}
<div class="panel panel-default choices-panel" id="data-{{ data.id }}-choices-panel">
	<div class="panel-heading">
		{{ 'Choices'|trans }}
	</div>
	<div class="panel-body">
		{% for choice in data.choices %}
		<div class="panel panel-default choice-container" data-id="{{ choice.id }}">
			<div class="panel-heading">
				{{ 'Choice %id%'|trans({ '%id%' : choice.id }) }}
			</div>
			<div class="panel-body" id="data-{{ data.id }}-choice-{{ choice.id }}-panel">
				<div class="attributes-container">
					<div>
					{{ page.showAttribute('data-'~data.id~'-choice-'~choice.id, 'text', 'value', 'Value'|trans, choice.value, choice.value, true, 'Choice value'|trans) }}
					{{ page.showAttribute('data-'~data.id~'-choice-'~choice.id, 'text', 'label', 'Label'|trans, choice.label, choice.label, true, 'Choice label'|trans) }}
					</div>
				</div>
			</div>
		</div>
		{% endfor %}
		{% if data.choiceSource is not empty %}
		{% set void = data.choiceSource.setCaseInsensitive(false) %}
		<div class="attributes-container choice-source-container" data-id="{{ data.choiceSource.id }}">
			<div>
			{{ page.showAttribute('data-'~data.id~'-choicesource-'~data.choiceSource.id, 'select', 'id', 'Source'|trans, data.choiceSource.id, data.choiceSource.id, true, 'Source'|trans, { (data.choiceSource.id): data.simulator.sourceById(data.choiceSource.id).label }) }}
			{{ page.showAttribute('data-'~data.id~'-choicesource-'~data.choiceSource.id, 'text', 'idColumn', 'Source column id'|trans, data.choiceSource.idColumn, data.choiceSource.idColumn, false, 'Source column id'|trans) }}
			{{ page.showAttribute('data-'~data.id~'-choicesource-'~data.choiceSource.id, 'text', 'valueColumn', 'Source column value'|trans, data.choiceSource.valueColumn, data.choiceSource.valueColumn, true, 'Source column value'|trans) }}
			{{ page.showAttribute('data-'~data.id~'-choicesource-'~data.choiceSource.id, 'text', 'labelColumn', 'Source column label'|trans, data.choiceSource.labelColumn, data.choiceSource.labelColumn, true, 'Source column label'|trans) }}
			</div>
		</div>
		{% endif %}
	</div>
</div>
{% endif %}

{{ page.closeCollapsiblePanel() }}

{% endmacro %}

{% macro showConditions(conditions) %}
{% import _self as page %}
{% for condition in conditions %}
{{ page.showCondition(condition) }}
{% endfor %}
{% endmacro %}

{% macro showCondition(condition) %}
{% import _self as page %}
{% if condition.all is defined and condition.all is not empty %}
	<li class="condition">{{ 'All of the following conditions are met'|trans }} : 
	<ul>
	{{ page.showConditions(condition.all) }}
	</ul>
	</li>
{% elseif condition.any is defined and condition.any is not empty %}
	<li class="condition">{{ 'Any of the following conditions is met'|trans }} : 
	<ul>
	{{ page.showConditions(condition.any) }}
	</ul>
	</li>
{% elseif condition.none is defined and condition.none is not empty %}
	<li class="condition">{{ 'None of the following conditions is met'|trans }} : 
	<ul>
	{{ page.showConditions(condition.none) }}
	</ul>
	</li>
{% else %}
	<li class="condition"><var class="data" data-id="{{ condition.id }}">«{{ condition.name }}»</var> {{ condition.operator }} {{ condition.value|jscode }}</li>
{% endif %}

{% endmacro %}

{% macro showProfiles(simulator) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('profiles' , 'Profiles'|trans, 'primary', '', '', [{ 'class': 'add-profile', 'label': 'Add'|trans, 'icon': 'glyphicon-plus-sign' }] ) }}
<div class="panel panel-default profiles-container" id="profiles-attributes-panel">
	<div class="panel-body">
		<div class="attributes-container">
			<div class="form-group col-sm-12">
				<label class="col-sm-2 control-label">{{ 'Title'|trans }}</label>
				<div class="col-sm-10">
					{% set profilesLabel = simulator.profiles is not empty ? simulator.profiles.label : '' %}
					<p data-attribute="label" data-value="{{ profilesLabel }}" class="form-control-static simple-value">{{ profilesLabel }}</p>
				</div>
			</div>
			<button class="btn btn-default pull-right update-button edit-profiles-label" data-parent="#profiles-attributes-panel" title="{{ 'Edit'|trans }}"><span class="button-label">{{ 'Edit'|trans }}</span> <span class="glyphicon glyphicon-pencil"></span></button>
		</div>
	</div>
</div>
<div class="panel panel-default profiles-panel" id="profiles-profiles-panel">
	<div class="panel-body sortable">
		{% if simulator.profiles is not empty %}
		{% for profile in simulator.profiles.profiles %}
			{{ page.showProfile(simulator, profile, 'profile', loop.index == 1 ? 'in' : '') }}
		{% endfor %}
		{% endif %}
	</div>
</div>
{{ page.closeCollapsiblePanel() }}  
{% endmacro %}

{% macro showProfile(simulator, profile, containerType, inClass) %}
{% import _self as page %}
{{ page.openCollapsiblePanel('profile-' ~ profile.id , '#'~profile.id~' : '~profile.label, 'info', inClass, '', [{ 'class': 'delete-profile', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'edit-profile', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' } ] ) }}
<div class="panel panel-default {{ containerType }}-container" id="profile-{{ profile.id }}-attributes-panel" data-id="{{ profile.id }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
			{{ page.showAttribute('profile-'~profile.id, 'text', 'name', 'Name'|trans, profile.name, profile.name, true, 'Name'|trans) }}
			{{ page.showAttribute('profile-'~profile.id, 'text', 'label', 'Label'|trans, profile.label, profile.label, true, 'Label'|trans) }}
			</div>
		</div>
		<div class="panel panel-default description-panel elements-container" id="profile-{{ profile.id }}-description-panel">
			<div class="panel-heading">
				{{ 'Description'|trans }}
			</div>
			<div class="panel-body profile-description rich-text">
				{{ page.paragraphs(simulator.replaceByDataLabel(profile.description)|jscode) }}
			</div>
		</div>
	</div>
</div>
{% if profile.datas is not empty %}
<div class="panel panel-success profile-datas-panel" id="profile-{{ profile.id }}-profile-datas-panel">
	<div class="panel-heading">
		<button class="btn btn-success pull-right update-button add-profile-data" data-parent="#profile-{{ profile.id }}-profile-datas-panel" title="{{ 'Add'|trans }}"><span class="button-label">{{ 'Add'|trans }}</span> <span class="glyphicon glyphicon-plus-sign"></span></button>
		<h4 class="panel-title">
			{{ 'Datas'|trans }}
		</h4>
	</div>
	<div class="panel-body sortable">
		{% for pdata in profile.datas %}
		{{ page.showProfileData(simulator, profile.id, loop.index, pdata) }}
		{% endfor %}
	</div>
</div>
{% endif %}
{{ page.closeCollapsiblePanel() }}
{% endmacro %}

{% macro showProfileData(simulator, profileId, id, pdata) %}
{% import _self as page %}
{% set data = simulator.dataById(pdata[0]) %}
{% set deflt = pdata[1] %}
{% set profileDataElementId = 'profile-'~profileId~'-profile-data-'~id %}
{{ page.openCollapsiblePanel(profileDataElementId , 'Data %id%'|trans({ '%id%' : id }) ~ ' : ' ~ data.label, 'default', '', '', [{ 'class': 'delete-profile-data', 'label': 'Delete'|trans, 'icon': 'glyphicon-minus-sign' }, { 'class': 'edit-profile-data', 'label': 'Edit'|trans, 'icon': 'glyphicon-pencil' }] ) }}
<div class="panel panel-default profile-data-container" id="{{ profileDataElementId }}-attributes-panel" data-profile="{{ profileId }}" data-id="{{ id }}">
	<div class="panel-body">
		<div class="attributes-container">
			<div>
				{{ page.showAttribute('profile-'~profileId~'-data-'~id, 'select', 'data', 'Data'|trans, data.id, data.id, true, 'Profile data'|trans, { (data.id): data.label }) }}
				{% if data.type == 'choice' or data.type == 'multichoice' %}
				{{ page.showAttribute('profile-'~profileId~'-data-'~id, 'select', 'default', 'Profile data value'|trans, deflt, deflt, true, 'Profile data value'|trans, { (deflt): data.choiceLabelByValue(deflt) }) }}
				{% else %}
				{{ page.showAttribute('profile-'~profileId~'-data-'~id, 'text', 'default', 'Profile data value'|trans, deflt, deflt, true, 'Profile data value'|trans) }}
				{% endif %}
				</div>
		</div>
	</div>
</div>
{{ page.closeCollapsiblePanel() }}
{% endmacro %}

{% macro paragraphs(text) %}
	{% set paragraphs = text|trim|split("\n") %}
	{% if paragraphs is not empty %}
		{% if paragraphs|length == 1 %}
			{{ paragraphs[0]|jscode }}
		{% else %}
			{%- for paragraph in paragraphs -%}
				<p>{%- if paragraph|trim is empty -%}&nbsp;{%- else -%}{{ paragraph|jscode }}{%- endif -%}</p>
			{% endfor %}
		{% endif %}
	{% endif %}
{% endmacro %}


